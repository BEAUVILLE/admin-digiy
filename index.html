<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DIGIY Admin ‚Äî Activations</title>

  <style>
    :root{
      --bg:#0a0e1a; --card:#1a1f2e; --accent:#facc15;
      --success:#22c55e; --danger:#ef4444; --text:#e5e7eb;
      --muted:#9ca3af; --border:rgba(148,163,184,0.2);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      background:linear-gradient(135deg,#0a0e1a,#1a1f2e);
      color:var(--text);
      font-family:system-ui,-apple-system,sans-serif;
      padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}
    header{
      background:rgba(26,31,46,0.8);
      backdrop-filter:blur(10px);
      padding:20px;border-radius:16px;border:1px solid var(--border);
      margin-bottom:24px;
      display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;
    }
    .logo{display:flex;align-items:center;gap:12px;}
    .logo-icon{
      width:48px;height:48px;
      background:linear-gradient(135deg,#facc15,#eab308);
      border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
    }
    h1{font-size:24px;font-weight:900;}
    .header-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{
      padding:10px 16px;border:none;border-radius:10px;
      font-size:14px;font-weight:800;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
      transition:transform .08s ease, opacity .12s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-success{background:var(--success);color:#fff;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-secondary{
      background:rgba(255,255,255,.1);
      color:var(--text);border:1px solid var(--border);
    }
    .refresh-btn{
      background:rgba(250,204,21,0.1);
      color:var(--accent);
      border:1px solid rgba(250,204,21,0.3);
    }
    .section{
      background:var(--card);
      border-radius:16px;border:1px solid var(--border);
      padding:24px;margin-bottom:24px;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .empty{text-align:center;padding:40px;color:var(--muted);}
    .err{
      margin-top:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
      color:#fecaca;
      font-weight:800;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:800;font-size:13px;
      margin-top:10px;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="container">

  <header>
    <div class="logo">
      <div class="logo-icon">ü¶Ö</div>
      <div>
        <h1>DIGIY Admin</h1>
        <div style="font-size:13px;color:var(--muted)">Activations Paiement ‚Üí Acc√®s PRO</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn refresh-btn" id="btnRefresh">üîÑ Actualiser</button>
      <button class="btn btn-danger" id="btnLogout">üö™ D√©connexion</button>
    </div>
  </header>

  <div class="section">
    <h2>‚è≥ Demandes en attente</h2>
    <div id="pendingList" class="empty">Chargement‚Ä¶</div>
    <div id="pendingErr" class="err" style="display:none"></div>
  </div>

</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const KEY = { token:"digiy_admin_token", exp:"digiy_admin_exp" };

/* =========================================================
   SUPABASE CLIENT (UNIQUE)
========================================================= */
const sb = window.__digiy_sb_admin
  || (window.__digiy_sb_admin = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

/* =========================================================
   UTILS
========================================================= */
const $ = (id)=>document.getElementById(id);

function showErr(id, msg){
  const el = $(id);
  if(!el) return;
  if(!msg){
    el.style.display = "none";
    el.textContent = "";
    return;
  }
  el.style.display = "block";
  el.textContent = String(msg);
}

function getTokenOrKick(){
  const tok = localStorage.getItem(KEY.token) || "";
  const exp = Number(localStorage.getItem(KEY.exp) || "0");
  if(!tok || !exp || Date.now() > exp){
    location.replace("login.html");
    return "";
  }
  return tok;
}

function logout(){
  if(confirm("Se d√©connecter ?")){
    localStorage.removeItem(KEY.token);
    localStorage.removeItem(KEY.exp);
    location.replace("login.html");
  }
}

function disableAllActionButtons(disabled){
  document.querySelectorAll("[data-action-btn='1']").forEach(b=>{
    b.disabled = !!disabled;
  });
}

/* =========================================================
   üîê ADMIN CHECK (TOKEN-BASED)
========================================================= */
let IS_ADMIN = false;

async function checkAdmin(){
  const tok = getTokenOrKick();
  if(!tok) return false;

  const { data, error } = await sb.rpc("digiy_admin_check", { p_token: tok });
  if(error){
    console.error("digiy_admin_check error:", error);
    IS_ADMIN = false;
    return false;
  }

  IS_ADMIN = (data === true);
  return IS_ADMIN;
}

/* =========================================================
   ACTIONS (RPC)
========================================================= */
window.approveReq = async function(phone, module, price, months){
  if(!IS_ADMIN) return alert("‚õî Acc√®s refus√© (non admin).");
  if(!confirm(`Activer ${String(module||"").toUpperCase()} pour ${phone} (${months} mois) ?`)) return;

  disableAllActionButtons(true);
  showErr("pendingErr", null);

  try{
    const tok = getTokenOrKick();
    if(!tok) return;

    const { data, error } = await sb.rpc("digiy_admin_approve_request", {
      p_token: tok,
      p_phone: phone,
      p_module: module,
      p_price_monthly: Number(price || 9900),
      p_months: Number(months || 1)
    });

    if(error) throw error;
    if(!data?.ok) throw new Error(data?.reason || "approve_failed");

    alert("‚úÖ Activ√©");
    await loadPending();

  }catch(err){
    console.error("approveReq error:", err);
    alert("‚ùå " + (err?.message || err));
  }finally{
    disableAllActionButtons(false);
  }
};

window.rejectReq = async function(id){
  if(!IS_ADMIN) return alert("‚õî Acc√®s refus√© (non admin).");
  if(!confirm("Refuser cette demande ?")) return;

  disableAllActionButtons(true);
  showErr("pendingErr", null);

  try{
    const tok = getTokenOrKick();
    if(!tok) return;

    const { data, error } = await sb.rpc("digiy_admin_reject_request", {
      p_token: tok,
      p_id: id
    });

    if(error) throw error;
    if(!data?.ok) throw new Error(data?.reason || "reject_failed");

    alert("‚úÖ Refus√©");
    await loadPending();

  }catch(err){
    console.error("rejectReq error:", err);
    alert("‚ùå " + (err?.message || err));
  }finally{
    disableAllActionButtons(false);
  }
};

/* =========================================================
   DATA
========================================================= */
async function loadPending(){
  $("pendingList").textContent = "Chargement‚Ä¶";
  showErr("pendingErr", null);

  const tok = getTokenOrKick();
  if(!tok) return;

  const { data, error, status } = await sb.rpc("digiy_admin_list_requests", {
    p_token: tok,
    p_status: "pending_payment",
    p_limit: 100
  });

  if(error){
    console.error("digiy_admin_list_requests error:", error);
    $("pendingList").textContent = "Erreur chargement";
    showErr("pendingErr",
      `RPC digiy_admin_list_requests a √©chou√©.\nStatus: ${status}\nMessage: ${error.message || error}`
    );
    return;
  }

  if(!data || data.length === 0){
    $("pendingList").innerHTML = "<div class='empty'>Aucune demande</div>";
    return;
  }

  $("pendingList").innerHTML = data.map(item => {
    const name   = item.full_name || item.business_name || item.slug || "‚Äî";
    const phone  = item.phone || "‚Äî";
    const module = (item.preferred_module || item.module || "LOC");
    const price  = Number(item?.partner_data?.price || item.price_monthly || 9900);
    const reqId  = item.id || item.request_id || item.inscription_id || null;

    return `
      <div class="section">
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
          <div>
            <div style="font-weight:900;font-size:18px">${escapeHtml(String(name))}</div>
            <div class="chip">üì± <span class="mono">${escapeHtml(String(phone))}</span></div>
            <div class="chip">üì¶ <span class="mono">${escapeHtml(String(module).toUpperCase())}</span> ‚Ä¢ üí∞ <span class="mono">${price.toLocaleString("fr-FR")} F</span></div>
          </div>
        </div>

        <div class="actions">
          <button data-action-btn="1" class="btn btn-success"
            onclick="approveReq('${escapeAttr(String(phone))}','${escapeAttr(String(module))}',${price},1)">
            Activer (1 mois)
          </button>

          <button data-action-btn="1" class="btn btn-secondary"
            onclick="approveReq('${escapeAttr(String(phone))}','${escapeAttr(String(module))}',${price},3)">
            Activer (3 mois)
          </button>

          <button data-action-btn="1" class="btn btn-danger"
            onclick="rejectReq('${escapeAttr(String(reqId || ""))}')"
            ${reqId ? "" : "disabled"}
            title="${reqId ? "Refuser" : "ID manquant dans le retour RPC"}">
            Refuser
          </button>
        </div>
      </div>
    `;
  }).join("");

  // si non-admin, on masque les boutons sensibles (s√©curit√© UX)
  if(!IS_ADMIN){
    document.querySelectorAll(".btn-success,.btn-danger,.btn-secondary").forEach(b=>{
      b.style.display = "none";
    });
  }
}

/* =========================================================
   SAFETY HELPERS (anti injection dans HTML)
========================================================= */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){
  return escapeHtml(s).replaceAll("`","&#096;");
}

/* =========================================================
   INIT
========================================================= */
window.addEventListener("load", async ()=>{
  getTokenOrKick();

  await checkAdmin();

  if(!IS_ADMIN){
    document.querySelectorAll(".btn-success,.btn-danger,.btn-secondary").forEach(b=>{
      b.style.display = "none";
    });
  }

  $("btnRefresh").onclick = loadPending;
  $("btnLogout").onclick = logout;

  console.log("ü¶Ö DIGIY ADMIN READY ‚Ä¢ admin =", IS_ADMIN);

  loadPending();
});
</script>
</body>
</html>
