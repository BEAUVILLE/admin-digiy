<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DIGIY Admin ‚Äî Activations</title>

  <style>
    :root{
      --bg:#0a0e1a; --card:#1a1f2e; --accent:#facc15;
      --success:#22c55e; --danger:#ef4444; --text:#e5e7eb;
      --muted:#9ca3af; --border:rgba(148,163,184,0.2);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;min-height:100vh;
      background:linear-gradient(135deg,#0a0e1a,#1a1f2e);
      color:var(--text);
      font-family:system-ui,-apple-system,sans-serif;
      padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}

    header{
      background:rgba(26,31,46,0.8);
      backdrop-filter:blur(10px);
      padding:20px;border-radius:16px;border:1px solid var(--border);
      margin-bottom:24px;
      display:flex;justify-content:space-between;align-items:center;
      flex-wrap:wrap;gap:16px;
    }
    .logo{display:flex;align-items:center;gap:12px;}
    .logo-icon{
      width:48px;height:48px;background:linear-gradient(135deg,#facc15,#eab308);
      border-radius:12px;display:flex;align-items:center;justify-content:center;
      font-size:24px;box-shadow:0 0 20px rgba(250,204,21,0.3);
    }
    h1{font-size:24px;font-weight:900;}
    .header-actions{display:flex;gap:8px;flex-wrap:wrap;}

    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;margin-bottom:24px;
    }
    .stat-card{background:var(--card);padding:20px;border-radius:14px;border:1px solid var(--border);}
    .stat-label{font-size:13px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:8px;}
    .stat-value{font-size:32px;font-weight:900;color:var(--accent);}

    .section{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:24px;
      margin-bottom:24px;
    }
    .section-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:20px;flex-wrap:wrap;gap:12px;
    }
    h2{font-size:18px;font-weight:900;display:flex;align-items:center;gap:8px;}

    .inscription-card{
      background:rgba(15,23,42,0.5);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      transition:all .2s;
    }
    .inscription-card:hover{border-color:var(--accent);transform:translateY(-2px);}
    .inscription-header{
      display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;
      flex-wrap:wrap;gap:12px;
    }
    .inscription-info h3{font-size:18px;font-weight:900;margin-bottom:4px;}
    .inscription-details{font-size:14px;color:var(--muted);line-height:1.6;}

    .module-badge{
      display:inline-block;padding:6px 12px;
      background:linear-gradient(135deg,#facc15,#eab308);
      color:#0a0e1a;border-radius:8px;
      font-size:12px;font-weight:900;text-transform:uppercase;
    }

    .actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{
      padding:10px 16px;border:none;border-radius:10px;
      font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;
      display:inline-flex;align-items:center;gap:6px;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-success{background:var(--success);color:#fff;}
    .btn-success:hover{background:#16a34a}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#dc2626}
    .btn-secondary{
      background:rgba(255,255,255,.1);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{background:rgba(255,255,255,.15)}
    .refresh-btn{
      background:rgba(250,204,21,0.1);
      color:var(--accent);
      border:1px solid rgba(250,204,21,0.3);
    }
    .refresh-btn:hover{background:rgba(250,204,21,0.2);}

    .empty{text-align:center;padding:40px;color:var(--muted);}
    .empty-icon{font-size:48px;margin-bottom:16px;}

    table{width:100%;border-collapse:collapse;}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border);}
    th{font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;}
    td{font-size:14px;}

    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800;}
    .badge-active{background:rgba(34,197,94,0.2);color:var(--success);}
    .badge-pending{background:rgba(250,204,21,0.2);color:var(--accent);}
    .badge-soon{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.25);}

    .loading{text-align:center;padding:40px;}
    .spinner{
      border:4px solid rgba(250,204,21,0.2);
      border-top:4px solid var(--accent);
      border-radius:50%;
      width:40px;height:40px;
      animation:spin 1s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{
      margin-top:12px;padding:12px 14px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.45);
      color:var(--muted);
      font-weight:800;
      line-height:1.35;
    }

    @media(max-width:768px){
      body{padding:12px}
      header{padding:16px}
      .section{padding:16px}
      .stats{grid-template-columns:1fr}
      th,td{padding:8px}
      .header-actions{width:100%}
      .header-actions .btn{flex:1}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">ü¶Ö</div>
        <div>
          <h1>DIGIY Admin</h1>
          <div style="font-size:13px;color:var(--muted)">Activations Paiement ‚Üí Acc√®s PRO</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn refresh-btn" id="btnRefresh">üîÑ Actualiser</button>
        <button class="btn btn-danger" id="btnLogout">üö™ D√©connexion</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">En attente</div>
        <div class="stat-value" id="statPending">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Actifs</div>
        <div class="stat-value" id="statActive">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Revenus mois</div>
        <div class="stat-value" id="statRevenue">-</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>‚è≥ Demandes en attente</h2>
      </div>
      <div id="pendingList">
        <div class="loading"><div class="spinner"></div><div>Chargement...</div></div>
      </div>
      <div class="toast" id="toastPending">‚Äî</div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>‚úÖ Acc√®s actifs</h2>
      </div>
      <div id="activeList">
        <div class="loading"><div class="spinner"></div><div>Chargement...</div></div>
      </div>
      <div class="toast" id="toastActive">‚Äî</div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>‚è∞ Relance 7J</h2>
        <button class="btn refresh-btn" id="btnReloadExpiring">üîÅ Recharger</button>
      </div>
      <div id="expiringList">
        <div class="empty"><div class="empty-icon">üïäÔ∏è</div><div>Aucune relance charg√©e pour l‚Äôinstant</div></div>
      </div>
      <div class="toast" id="toastExpiring">‚Äî</div>
    </div>

  </div>

<script>
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  // ‚úÖ un seul client (√©vite le warning ‚ÄúMultiple GoTrueClient instances‚Äù)
 const sb = window.__digiy_sb_admin
  || (window.__digiy_sb_admin = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  ));

  const KEY = { token:"digiy_admin_token", exp:"digiy_admin_exp" };

  const $ = (id)=>document.getElementById(id);

  function toast(id, msg){
    const el = $(id);
    if(el) el.textContent = msg || "‚Äî";
  }

  function getTokenOrKick(){
    const tok = localStorage.getItem(KEY.token) || "";
    const exp = Number(localStorage.getItem(KEY.exp) || "0");
    if(!tok || !exp || Date.now() > exp){
      location.replace("login.html");
      return "";
    }
    return tok;
  }

  function logout(){
    if(confirm("Se d√©connecter ?")){
      localStorage.removeItem(KEY.token);
      localStorage.removeItem(KEY.exp);
      location.replace("login.html");
    }
  }

  async function loadStats(){
    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_stats", { p_token: tok });
      if(error) throw error;
      if(!data?.ok) throw new Error(data?.reason || "stats_failed");

      $("statPending").textContent = data.pending_count ?? 0;
      $("statActive").textContent  = data.active_count ?? 0;
      $("statRevenue").textContent =
        Number(data.revenue_month ?? 0).toLocaleString("fr-FR") + " F";

      toast("toastActive", "Stats OK ‚Ä¢ " + new Date().toLocaleTimeString("fr-FR"));
    }catch(err){
      console.error("‚ùå stats error:", err);
      toast("toastActive", "Stats erreur: " + (err.message||err));
    }
  }

  async function loadPendingInscriptions(){
    const container = $("pendingList");
    container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Chargement...</div></div>';

    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_list_requests", {
        p_token: tok,
        p_status: "pending_payment",
        p_limit: 200
      });
      if(error) throw error;

      if(!data || data.length === 0){
        container.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><div>Aucune demande en attente</div></div>';
        toast("toastPending", "0 demande en attente");
        return;
      }

      container.innerHTML = data.map(item => {
        const price = (item?.partner_data?.price) ? Number(item.partner_data.price) : 9900;
        const createdDate = item.created_at ? new Date(item.created_at).toLocaleDateString("fr-FR") : "‚Äî";
        const module = (item.preferred_module || "‚Äî");
        const slug = item?.partner_data?.slug || "‚Äî";

        return `
          <div class="inscription-card">
            <div class="inscription-header">
              <div class="inscription-info">
                <h3>${item.full_name || "‚Äî"}</h3>
                <div class="inscription-details">
                  üì± ${item.phone || "‚Äî"}<br>
                  üìç ${item.city || "‚Äî"}${item.address ? ", " + item.address : ""}<br>
                  üìÖ ${createdDate}<br>
                  üè∑Ô∏è slug: <b>${slug}</b>
                </div>
              </div>
              <div>
                <div class="module-badge">${module}</div>
                <div style="font-size:20px;font-weight:900;color:var(--accent);margin-top:8px">${price.toLocaleString("fr-FR")} F/mois</div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" onclick="approveReq('${item.phone}','${module}',${price},1)">‚úÖ Activer (1 mois)</button>
              <button class="btn btn-secondary" onclick="approveReq('${item.phone}','${module}',${price},3)">‚úÖ Activer (3 mois)</button>
              <button class="btn btn-danger" onclick="rejectReq('${item.id}')">‚ùå Refuser</button>
            </div>
          </div>`;
      }).join("");

      toast("toastPending", `${data.length} demande(s) en attente ‚Ä¢ ${new Date().toLocaleTimeString("fr-FR")}`);
    }catch(err){
      console.error("‚ùå pending error:", err);
      container.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div>Erreur: '+(err.message||err)+'</div></div>';
      toast("toastPending", "Erreur pending: " + (err.message||err));
    }
  }

  async function loadActiveSubscriptions(){
    const container = $("activeList");
    container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Chargement...</div></div>';

    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_list_active", { p_token: tok, p_limit: 500 });
      if(error) throw error;

      if(!data || data.length === 0){
        container.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><div>Aucun abonnement actif</div></div>';
        toast("toastActive", "0 actif");
        return;
      }

      const now = new Date();
      const rows = data.map(sub=>{
        const expDate = sub.current_period_end ? new Date(sub.current_period_end) : null;
        const isExpired = expDate ? (expDate < now) : false;
        const daysLeft = expDate ? Math.ceil((expDate - now) / (1000*60*60*24)) : null;

        return `
          <tr>
            <td><strong>${sub.phone}</strong></td>
            <td><span class="module-badge">${sub.module}</span></td>
            <td>${sub.plan || "‚Äî"}</td>
            <td><strong>${Number(sub.price_monthly||0).toLocaleString("fr-FR")} F</strong></td>
            <td>
              ${expDate ? expDate.toLocaleDateString("fr-FR") : "‚Äî"}<br>
              <small style="color:${(daysLeft!==null && daysLeft<7) ? "var(--danger)" : "var(--muted)"}">
                ${isExpired ? "‚ö†Ô∏è Expir√©" : (daysLeft!==null ? (daysLeft+" jours") : "‚Äî")}
              </small>
            </td>
            <td>
              <span class="badge ${isExpired ? "badge-pending" : "badge-active"}">
                ${isExpired ? "‚ö†Ô∏è Expir√©" : "‚úÖ Actif"}
              </span>
            </td>
          </tr>`;
      }).join("");

      container.innerHTML = `
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr><th>T√©l√©phone</th><th>Module</th><th>Plan</th><th>Prix</th><th>Expire le</th><th>Status</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;

      toast("toastActive", `${data.length} actif(s) ‚Ä¢ ${new Date().toLocaleTimeString("fr-FR")}`);
    }catch(err){
      console.error("‚ùå active error:", err);
      container.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div>Erreur: '+(err.message||err)+'</div></div>';
      toast("toastActive", "Erreur actifs: " + (err.message||err));
    }
  }

  // ‚úÖ WhatsApp auto apr√®s approve
  async function approveReq(phone, module, price, months){
    if (!confirm(`Activer ${module} pour ${phone} (${months} mois) ?`)) return;

    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_approve_request", {
        p_token: tok,
        p_phone: phone,
        p_module: module,
        p_price_monthly: price,
        p_months: months
      });
      if(error) throw error;
      if(!data?.ok) throw new Error(data?.reason || "approve_failed");

      const fmt = (iso)=>{
        if(!iso) return "‚Äî";
        const d = new Date(iso);
        return d.toLocaleDateString("fr-FR");
      };

      const moduleUp = String(data.module || module || "").toUpperCase();
      const plan = data.plan || (moduleUp + "_MONTHLY");
      const slug = String(data.slug || "").trim();

      const planningBase =
        (moduleUp === "LOC")
          ? "https://beauville.github.io/digiy-loc-pro/planning.html"
          : "https://beauville.github.io/digiy-hub/";

      const planningLink = slug ? (planningBase + "?slug=" + encodeURIComponent(slug)) : planningBase;

      const msg =
`ü¶Ö DIGIY ‚Äî Activation confirm√©e ‚úÖ

Module: ${moduleUp} PRO
Plan: ${plan}
T√©l√©phone: ${data.phone || phone}
P√©riode: du ${fmt(data.current_period_start)} au ${fmt(data.current_period_end)}

Acc√®s:
${planningLink}

Support WhatsApp: +221771342889
0% commission ¬∑ Paiement direct`;

      const wa = "https://wa.me/" + String(phone).replace(/\D/g,"") + "?text=" + encodeURIComponent(msg);
      window.open(wa, "_blank");

      alert("‚úÖ Activ√©. WhatsApp pr√™t √† envoyer.");
      loadData();

    }catch(err){
      console.error("‚ùå approve error:", err);
      alert("‚ùå Erreur: " + (err.message || err));
    }
  }
  window.approveReq = approveReq;

  async function rejectReq(id){
    if(!confirm("Refuser cette demande ?")) return;
    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_reject_request", { p_token: tok, p_id: id });
      if(error) throw error;
      if(!data?.ok) throw new Error(data?.reason || "reject_failed");

      alert("‚úÖ Refus√©");
      loadData();
    }catch(err){
      console.error("‚ùå reject error:", err);
      alert("‚ùå Erreur: " + (err.message||err));
    }
  }
  window.rejectReq = rejectReq;

  // ‚úÖ RELANCE 7J (RPC)
  async function loadExpiring7d(){
    const container = $("expiringList");
    container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Chargement...</div></div>';

    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_list_expiring", {
        p_token: tok,
        p_days: 7,
        p_limit: 200
      });
      if(error) throw error;

      if(!data || data.length === 0){
        container.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><div>Aucune expiration &lt; 7 jours</div></div>';
        toast("toastExpiring", "0 relance √† faire");
        return;
      }

      const now = new Date();
      const fmt = (iso)=>{
        if(!iso) return "‚Äî";
        return new Date(iso).toLocaleDateString("fr-FR");
      };

      container.innerHTML = data.map(x=>{
        const exp = x.current_period_end ? new Date(x.current_period_end) : null;
        const daysLeft = exp ? Math.ceil((exp - now)/(1000*60*60*24)) : null;
        const slug = x.slug || "‚Äî";

        return `
          <div class="inscription-card">
            <div class="inscription-header">
              <div class="inscription-info">
                <h3>üì± ${x.phone}</h3>
                <div class="inscription-details">
                  Module: <b>${x.module}</b> ‚Ä¢ Plan: ${x.plan || "‚Äî"}<br>
                  Expire: <b>${fmt(x.current_period_end)}</b>
                  ${daysLeft!==null ? `‚Ä¢ <span style="color:var(--danger);font-weight:900">${daysLeft}j</span>` : ""}
                  <br>
                  üè∑Ô∏è slug: <b>${slug}</b>
                </div>
              </div>
              <div>
                <div class="module-badge">${x.module}</div>
                <div style="font-size:20px;font-weight:900;color:var(--accent);margin-top:8px">
                  ${Number(x.price_monthly||0).toLocaleString("fr-FR")} F/mois
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn refresh-btn" onclick="waRelance('${x.phone}','${x.module}','${slug}','${x.current_period_end}','${x.price_monthly||0}')">
                üí¨ Relancer WhatsApp
              </button>
              <button class="btn btn-secondary" onclick="markReminded('${x.phone}','${x.module}')">
                ‚úÖ Marquer ‚Äúrelanc√©‚Äù
              </button>
            </div>
          </div>
        `;
      }).join("");

      toast("toastExpiring", `${data.length} relance(s) < 7 jours ‚Ä¢ ${new Date().toLocaleTimeString("fr-FR")}`);
    }catch(err){
      console.error("‚ùå expiring error:", err);
      container.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div>Erreur: '+(err.message||err)+'</div></div>';
      toast("toastExpiring", "Erreur relance: " + (err.message||err));
    }
  }

  function waRelance(phone, module, slug, expIso, price){
    const fmt = (iso)=> iso ? new Date(iso).toLocaleDateString("fr-FR") : "‚Äî";
    const moduleUp = String(module||"").toUpperCase();

    const planningBase =
      (moduleUp === "LOC")
        ? "https://beauville.github.io/digiy-loc-pro/planning.html"
        : "https://beauville.github.io/digiy-hub/";

    const link = (slug && slug !== "‚Äî")
      ? (planningBase + "?slug=" + encodeURIComponent(slug))
      : planningBase;

    const msg =
`ü¶Ö DIGIY ‚Äî Rappel abonnement ‚úÖ

T√©l√©phone: ${phone}
Module: ${moduleUp} PRO
Expiration: ${fmt(expIso)}
Renouvellement: ${Number(price||0).toLocaleString("fr-FR")} F / mois

Paiement Wave ‚Üí puis envoi du re√ßu ici ‚úÖ
Support: +221771342889

Acc√®s:
${link}

0% commission ¬∑ Paiement direct`;

    const wa = "https://wa.me/" + String(phone).replace(/\D/g,"") + "?text=" + encodeURIComponent(msg);
    window.open(wa, "_blank");
  }
  window.waRelance = waRelance;

  async function markReminded(phone, module){
    try{
      const tok = getTokenOrKick();
      if(!tok) return;

      const { data, error } = await sb.rpc("digiy_admin_mark_reminded", {
        p_token: tok,
        p_phone: phone,
        p_module: module
      });
      if(error) throw error;
      if(!data?.ok) throw new Error(data?.reason || "mark_failed");

      alert("‚úÖ Marqu√© relanc√©");
      loadExpiring7d();
    }catch(err){
      console.error("‚ùå mark reminded error:", err);
      alert("‚ùå Erreur: " + (err.message||err));
    }
  }
  window.markReminded = markReminded;

  async function loadData(){
    console.log("üîÑ loadData", new Date().toISOString());
    await Promise.all([loadPendingInscriptions(), loadActiveSubscriptions(), loadStats()]);
  }

  window.addEventListener("load", ()=>{
    getTokenOrKick();
    $("btnRefresh").onclick = loadData;
    $("btnLogout").onclick = logout;
    $("btnReloadExpiring").onclick = loadExpiring7d;

    console.log("ü¶Ö DIGIY Admin (RPC) charg√©");
    loadData();
    loadExpiring7d();

    // ‚úÖ Automatisation clean: refresh toutes les 45s (moins agressif)
    setInterval(()=>{ loadStats(); }, 45000);
  });
</script>
</body>
</html>
