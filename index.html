<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DIGIY Admin ‚Äî Activations</title>

  <style>
    :root{
      --bg:#0a0e1a;
      --card:#1a1f2e;
      --accent:#facc15;
      --success:#22c55e;
      --danger:#ef4444;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(148,163,184,0.2);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;min-height:100vh;
      background:linear-gradient(135deg,#0a0e1a,#1a1f2e);
      color:var(--text);
      font-family:system-ui,-apple-system,sans-serif;
      padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}

    header{
      background:rgba(26,31,46,0.8);
      backdrop-filter:blur(10px);
      padding:20px;
      border-radius:16px;
      border:1px solid var(--border);
      margin-bottom:24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:16px;
    }
    .logo{display:flex;align-items:center;gap:12px;}
    .logo-icon{
      width:48px;height:48px;
      background:linear-gradient(135deg,#facc15,#eab308);
      border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      box-shadow:0 0 20px rgba(250,204,21,0.3);
    }
    h1{font-size:24px;font-weight:900;}
    .header-actions{display:flex;gap:8px;flex-wrap:wrap;}

    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-bottom:24px;
    }
    .stat-card{
      background:var(--card);
      padding:20px;
      border-radius:14px;
      border:1px solid var(--border);
    }
    .stat-label{
      font-size:13px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:8px;
    }
    .stat-value{font-size:32px;font-weight:900;color:var(--accent);}

    .section{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:24px;
      margin-bottom:24px;
    }
    .section-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:20px;flex-wrap:wrap;gap:12px;
    }
    h2{font-size:18px;font-weight:900;display:flex;align-items:center;gap:8px;}

    .inscription-card{
      background:rgba(15,23,42,0.5);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      transition:all .2s;
    }
    .inscription-card:hover{border-color:var(--accent);transform:translateY(-2px);}
    .inscription-header{
      display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;
      flex-wrap:wrap;gap:12px;
    }
    .inscription-info h3{font-size:18px;font-weight:900;margin-bottom:4px;}
    .inscription-details{font-size:14px;color:var(--muted);line-height:1.6;}

    .module-badge{
      display:inline-block;
      padding:6px 12px;
      background:linear-gradient(135deg,#facc15,#eab308);
      color:#0a0e1a;
      border-radius:8px;
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
    }

    .actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{
      padding:10px 16px;border:none;border-radius:10px;
      font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;
      display:inline-flex;align-items:center;gap:6px;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-success{background:var(--success);color:#fff;}
    .btn-success:hover{background:#16a34a}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#dc2626}
    .btn-secondary{
      background:rgba(255,255,255,.1);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{background:rgba(255,255,255,.15)}
    .refresh-btn{
      background:rgba(250,204,21,0.1);
      color:var(--accent);
      border:1px solid rgba(250,204,21,0.3);
    }
    .refresh-btn:hover{background:rgba(250,204,21,0.2);}

    .empty{text-align:center;padding:40px;color:var(--muted);}
    .empty-icon{font-size:48px;margin-bottom:16px;}

    table{width:100%;border-collapse:collapse;}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border);}
    th{font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;}
    td{font-size:14px;}

    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800;}
    .badge-active{background:rgba(34,197,94,0.2);color:var(--success);}
    .badge-pending{background:rgba(250,204,21,0.2);color:var(--accent);}

    .loading{text-align:center;padding:40px;}
    .spinner{
      border:4px solid rgba(250,204,21,0.2);
      border-top:4px solid var(--accent);
      border-radius:50%;
      width:40px;height:40px;
      animation:spin 1s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{
      margin-top:12px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.45);
      color:var(--muted);
      font-weight:800;
      line-height:1.35;
    }

    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:100%;
      max-width:460px;
      background:rgba(26,31,46,0.95);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal h3{font-size:18px;font-weight:900;margin-bottom:10px;}
    .modal input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:16px;
      margin-top:8px;
    }
    .modal .help{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}
    .modal .row{display:flex;gap:10px;margin-top:12px;}
    .modal .row .btn{flex:1;}
    @media(max-width:768px){
      body{padding:12px}
      header{padding:16px}
      .section{padding:16px}
      .stats{grid-template-columns:1fr}
      th,td{padding:8px}
      .header-actions{width:100%}
      .header-actions .btn{flex:1}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">ü¶Ö</div>
        <div>
          <h1>DIGIY Admin</h1>
          <div style="font-size:13px;color:var(--muted)">Activations Paiement ‚Üí Acc√®s PRO</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn refresh-btn" id="btnRefresh">üîÑ Actualiser</button>
        <button class="btn btn-danger" id="btnLogout">üö™ D√©connexion</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">En attente</div>
        <div class="stat-value" id="statPending">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Actifs</div>
        <div class="stat-value" id="statActive">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Revenus mois</div>
        <div class="stat-value" id="statRevenue">-</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>‚è≥ Demandes en attente</h2>
      </div>
      <div id="pendingList">
        <div class="loading">
          <div class="spinner"></div>
          <div>Chargement...</div>
        </div>
      </div>
      <div class="toast" id="toastPending">‚Äî</div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>‚úÖ Acc√®s actifs</h2>
      </div>
      <div id="activeList">
        <div class="loading">
          <div class="spinner"></div>
          <div>Chargement...</div>
        </div>
      </div>
      <div class="toast" id="toastActive">‚Äî</div>
    </div>
  </div>

  <!-- PIN MODAL -->
  <div class="modalBack" id="pinModal" style="display:none;">
    <div class="modal">
      <h3>üîê Connexion Admin</h3>
      <div style="color:var(--muted);font-size:13px;line-height:1.35;">
        Entre ton <b>PIN admin</b>. Token valable 8h (stock√© localement).
      </div>
      <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="help">
        Si tu n‚Äôas pas encore cr√©√© le PIN : dans SQL, ajoute une ligne dans <b>digiy_admin_pins</b> avec <code>crypt()</code>.
      </div>
      <div class="row">
        <button class="btn btn-secondary" id="btnCancelPin">Annuler</button>
        <button class="btn refresh-btn" id="btnLoginPin">Se connecter</button>
      </div>
      <div class="toast" id="pinMsg" style="margin-top:12px;">‚Äî</div>
    </div>
  </div>

  <script>
    // =============================
    // SUPABASE
    // =============================
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =============================
    // ADMIN TOKEN STORAGE
    // =============================
    const KEY = { token:"digiy_admin_token", exp:"digiy_admin_exp" };

    const SUPPORT_WA = "+221771342889"; // signature support DIGIY

    const $ = (id)=>document.getElementById(id);

    function fmtXOF(n){
      n = Number(n||0);
      if(!isFinite(n) || n<=0) return "-";
      return n.toLocaleString("fr-FR") + " F";
    }
    function nowMs(){ return Date.now(); }
    function hasValidToken(){
      const tok = localStorage.getItem(KEY.token) || "";
      const exp = Number(localStorage.getItem(KEY.exp) || "0");
      return !!tok && !!exp && nowMs() < exp;
    }
    function getToken(){
      if(!hasValidToken()) return "";
      return localStorage.getItem(KEY.token) || "";
    }

    function toast(id, msg){ $(id).textContent = msg || "‚Äî"; }

    function showPinModal(show){
      $("pinModal").style.display = show ? "flex" : "none";
      if(show) setTimeout(()=> $("pin").focus(), 50);
    }

    async function loginPin(){
      const pin = ($("pin").value || "").trim();
      if(!pin || pin.length < 4){
        toast("pinMsg", "‚ùå PIN invalide (4+ chiffres).");
        return;
      }
      toast("pinMsg", "‚è≥ Connexion...");
      try{
        const { data, error } = await sb.rpc("digiy_admin_login_pin", { p_pin: pin });
        if(error) throw error;
        if(!data || data.ok !== true){
          toast("pinMsg", "‚ùå Mauvais PIN.");
          return;
        }
        localStorage.setItem(KEY.token, String(data.token));
        localStorage.setItem(KEY.exp, String(data.exp));
        $("pin").value = "";
        toast("pinMsg", "‚úÖ Connect√©. Token 8h.");
        showPinModal(false);
        await loadData();
      }catch(e){
        console.log("DEBUG:", JSON.stringify(data, null, 2));
        toast("pinMsg", "üî¥ Erreur: " + String(e?.message || e));
      }
    }

    function logout(){
      try{ localStorage.removeItem(KEY.token); localStorage.removeItem(KEY.exp); }catch(_){}
      toast("toastPending", "D√©connect√©.");
      toast("toastActive", "D√©connect√©.");
      showPinModal(true);
    }

    function wa(phone, msg){
      const url = "https://wa.me/" + String(phone||"").replace(/\+/g,"") + "?text=" + encodeURIComponent(msg);
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // =============================
    // LOAD DATA (RPC ONLY)
    // =============================
    async function loadStats(){
      const tok = getToken();
      const { data, error } = await sb.rpc("digiy_admin_stats", { p_token: tok });
      if(error) throw error;
      if(!data || data.ok !== true) throw new Error(data?.reason || "NOT_ADMIN");

      $("statPending").textContent = data.pending ?? 0;
      $("statActive").textContent = data.active ?? 0;
      $("statRevenue").textContent = fmtXOF(data.revenue_month ?? 0);
    }

    async function loadPending(){
      const container = $("pendingList");
      container.innerHTML = `<div class="loading"><div class="spinner"></div><div>Chargement...</div></div>`;
      const tok = getToken();

      const { data, error } = await sb.rpc("digiy_admin_list_requests", {
        p_token: tok,
        p_status: "pending",
        p_limit: 120
      });
      if(error) throw error;

      const list = Array.isArray(data) ? data : [];
      toast("toastPending", `‚úÖ ${list.length} demande(s) en attente.`);

      if(!list.length){
        container.innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><div>Aucune demande en attente</div></div>`;
        return;
      }

      container.innerHTML = list.map(item=>{
        const createdDate = new Date(item.created_at).toLocaleString('fr-FR');
        const price = item.amount_xof || 0;
        const mod = (item.module || "‚Äî");
        const plan = (item.plan || "‚Äî");

        return `
          <div class="inscription-card">
            <div class="inscription-header">
              <div class="inscription-info">
                <h3>${item.phone || "‚Äî"}</h3>
                <div class="inscription-details">
                  üì¶ <b>${mod}</b> ‚Ä¢ plan: ${plan}<br>
                  üè∑Ô∏è ${item.slug || "‚Äî"}<br>
                  üßæ preuve: ${item.proof_text || "‚Äî"}<br>
                  üìÖ ${createdDate}
                </div>
              </div>
              <div>
                <div class="module-badge">${mod}</div>
                <div style="font-size:20px;font-weight:900;color:var(--accent);margin-top:8px">
                  ${fmtXOF(price)}
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" data-act="approve" data-id="${item.id}" data-phone="${item.phone}" data-module="${mod}" data-plan="${plan}" data-months="1">
                ‚úÖ Activer (1 mois)
              </button>
              <button class="btn btn-secondary" data-act="approve" data-id="${item.id}" data-phone="${item.phone}" data-module="${mod}" data-plan="${plan}" data-months="3">
                ‚úÖ Activer (3 mois)
              </button>
              <button class="btn btn-danger" data-act="reject" data-id="${item.id}">
                ‚ùå Refuser
              </button>
              <button class="btn btn-secondary" data-act="wa" data-phone="${item.phone}" data-module="${mod}" data-plan="${plan}">
                üí¨ WhatsApp
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async (ev)=>{
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          const phone = btn.getAttribute("data-phone");
          const mod = btn.getAttribute("data-module");
          const plan = btn.getAttribute("data-plan");
          const months = Number(btn.getAttribute("data-months") || "1");

          if(act === "wa"){
            const msg =
`DIGIY ‚Ä¢ Paiement en cours

üì¶ Module: ${mod}
üßæ Plan: ${plan}
üì± T√©l√©phone: ${phone}

Envoie le re√ßu Wave ici et on active.

‚Äî DIGIY`;
            wa(phone, msg);
            return;
          }

          if(act === "reject"){
            const note = prompt("Motif (optionnel) :", "Paiement non trouv√© / re√ßu illisible / montant incorrect");
            btn.disabled = true;
            btn.textContent = "‚è≥ Refus...";
            try{
              const tok = getToken();
              const { data, error } = await sb.rpc("digiy_admin_reject_request", {
                p_token: tok,
                p_request_id: id,
                p_note: note || null
              });
              if(error) throw error;
              if(!data || data.ok !== true) throw new Error(data?.reason || "REJECT_FAILED");
              await loadData();
            }catch(e){
              console.error(e);
              alert("‚ùå Erreur: " + String(e?.message || e));
              btn.disabled = false;
              btn.textContent = "‚ùå Refuser";
            }
            return;
          }

          if(act === "approve"){
            const ok = confirm(`Activer ${mod} pour ${phone} (${months} mois) ?`);
            if(!ok) return;

            btn.disabled = true;
            btn.textContent = "‚è≥ Activation...";
            try{
              const tok = getToken();

              // 1) approve request -> creates access
              const note = "Paiement v√©rifi√© Wave ‚úÖ";
              const { data, error } = await sb.rpc("digiy_admin_approve_request", {
                p_token: tok,
                p_request_id: id,
                p_note: note,
                p_active_until: null
              });
              if(error) throw error;
              if(!data || data.ok !== true) throw new Error(data?.reason || "APPROVE_FAILED");

              // 2) set active_until (1/3 mois)
              const { data: d2, error: e2 } = await sb.rpc("digiy_admin_set_active_until", {
                p_token: tok,
                p_phone: phone,
                p_module: mod,
                p_months: months
              });
              if(e2) throw e2;
              if(!d2 || d2.ok !== true) throw new Error(d2?.reason || "SET_UNTIL_FAILED");

              // 3) WhatsApp pro (option)
              const send = confirm("Envoyer WhatsApp au pro (Activation OK) ?");
              if(send){
                const msg =
`DIGIY ‚Ä¢ Activation OK ‚úÖ

üì¶ Module: ${mod}
üßæ Plan: ${plan}
üì± T√©l√©phone: ${phone}

Ton acc√®s est ACTIV√â.
Retourne dans l‚Äôapp ‚Üí ‚ÄúRafra√Æchir statut‚Äù ‚Üí ACTIF.

‚Äî DIGIY`;
                wa(phone, msg);
              }

              await loadData();
            }catch(e){
              console.error(e);
              alert("‚ùå Erreur: " + String(e?.message || e));
              btn.disabled = false;
              btn.textContent = months === 3 ? "‚úÖ Activer (3 mois)" : "‚úÖ Activer (1 mois)";
            }
          }
        });
      });
    }

    async function loadActive(){
      const container = $("activeList");
      container.innerHTML = `<div class="loading"><div class="spinner"></div><div>Chargement...</div></div>`;
      const tok = getToken();

      const { data, error } = await sb.rpc("digiy_admin_list_active", { p_token: tok, p_limit: 200 });
      if(error) throw error;

      const list = Array.isArray(data) ? data : [];
      toast("toastActive", `‚úÖ ${list.length} acc√®s actif(s).`);

      if(!list.length){
        container.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><div>Aucun acc√®s actif</div></div>`;
        return;
      }

      const html =
        `<div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>T√©l√©phone</th>
                <th>Module</th>
                <th>Plan</th>
                <th>Expire le</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(a=>{
                const exp = a.active_until ? new Date(a.active_until) : null;
                const expTxt = exp ? exp.toLocaleDateString("fr-FR") : "‚Äî";
                const active = true;
                return `
                  <tr>
                    <td><strong>${a.phone}</strong></td>
                    <td><span class="module-badge">${a.module}</span></td>
                    <td>${a.plan || "‚Äî"}</td>
                    <td>${expTxt}</td>
                    <td><span class="badge badge-active">‚úÖ Actif</span></td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>`;

      container.innerHTML = html;
    }

    async function loadData(){
      if(!hasValidToken()){
        showPinModal(true);
        return;
      }
      try{
        await loadStats();
        await loadPending();
        await loadActive();
      }catch(e){
        console.error(e);
        toast("toastPending", "üî¥ Erreur: " + String(e?.message || e));
        toast("toastActive", "üî¥ Erreur: " + String(e?.message || e));
        // token invalide -> re-login
        showPinModal(true);
      }
    }

    // Buttons
    $("btnRefresh").addEventListener("click", loadData);
    $("btnLogout").addEventListener("click", ()=>{ if(confirm("Se d√©connecter ?")) logout(); });

    $("btnCancelPin").addEventListener("click", ()=>{ /* stay locked */ });
    $("btnLoginPin").addEventListener("click", loginPin);
    $("pin").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginPin(); });

    // Boot
    window.addEventListener("load", ()=>{
      if(!hasValidToken()) showPinModal(true);
      loadData();
      setInterval(loadData, 30000); // auto-refresh 30s
    });
  </script>
</body>
</html>
